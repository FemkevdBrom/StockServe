@page
@model StockServe.Pages.GerechtDashbordModel
@{
    var tableId = Model.TableId; // Tafel ID ophalen
}
<div class="container-fluid bg-dark text-light p-3" style="height: 100vh;">
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @Model.ErrorMessage
        </div>
    }
    <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-md-3 bg-secondary text-center rounded p-3">
            <h2>Menu</h2> 
            <p>Table: @tableId</p> <!--Toont welke tafel geselecteerd is-->
            <div class="d-grid gap-2 my-3">
                <!-- Main Navigation Buttons -->
                <form method="post">
                    <button type="submit" asp-page-handler="SetOptionType" asp-route-optionType="Bestelling"
                    class="btn @(Model.CurrentOption == "Bestelling" ? "btn-primary" : "btn-light") mb-2 w-100">
                        Bestelling
                    </button>

                    <button type="submit" asp-page-handler="SetOptionType" asp-route-optionType="Rekening"
                    class="btn @(Model.CurrentOption == "Rekening" ? "btn-primary" : "btn-light") mb-2 w-100">
                        Rekening
                    </button>

                    <button type="submit" asp-page-handler="SetOptionType" asp-route-optionType="Betalen"
                    class="btn @(Model.CurrentOption == "Betalen" ? "btn-primary" : "btn-light") mb-2 w-100">
                        Betalen
                    </button>

                    <button type="submit" asp-page-handler="SetOptionType" asp-route-optionType="Terug"
                    class="btn @(Model.CurrentOption == "Terug" ? "btn-primary" : "btn-light") mb-2 w-100">
                        Terug
                    </button>
                </form>

                <!-- Action Buttons based on selected option -->
                <div class="d-flex justify-content-around mt-3">
                    @if (Model.CurrentOption == "Bestelling")
                    {
                        <form method="post">
                            <button type="submit" asp-page-handler="BestellingToevoegen" class="btn btn-outline-light me-2 w-100">Bestelling toevoegen</button>
                            <button type="submit" asp-page-handler="SetOptionType" asp-route-optionType="VerwijderGerecht" class="btn btn-outline-light me-2 w-100">Verwijder gerecht</button>
                            <button type="submit" asp-page-handler="OpmerkingToevoegenGerecht" class="btn btn-outline-light me-2 w-100">Opmerking toevoegen aan gerecht</button>
                        </form>
                    }
                    else if (Model.CurrentOption == "Rekening")
                    {
                        <div class="w-100">
                            <h4>Rekening Overzicht</h4>
                            @if (Model.TableOrderDishes != null && Model.TableOrderDishes.Any())
                            {
                                <div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
                                    <table class="table table-dark table-sm">
                                        <thead>
                                            <tr>
                                                <th style="width: 40%">Gerecht</th>
                                                <th style="width: 15%">Aantal</th>
                                                <th style="width: 20%">Prijs</th>
                                                <th style="width: 25%">Totaal</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @{
                                                var dishService = new StockServe.Logic.DishService();
                                                var allDishes = dishService.GetAllDishes();
                                                decimal totalAmount = 0;
                                            }
                                            @foreach (var orderDish in Model.TableOrderDishes)
                                            {
                                                var dish = allDishes.FirstOrDefault(d => d.Id == orderDish.DishId);
                                                if (dish != null)
                                                {
                                                    var dishTotal = dish.Price * orderDish.Amount;
                                                    totalAmount += dishTotal;
                                                    <tr>
                                                        <td style="word-wrap: break-word; white-space: normal;">@dish.Name</td>
                                                        <td>@orderDish.Amount</td>
                                                        <td>€@dish.Price.ToString("0.00")</td>
                                                        <td>€@dishTotal.ToString("0.00")</td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" class="text-end"><strong>Totaal:</strong></td>
                                                <td><strong>€@totalAmount.ToString("0.00")</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <p>Geen items op rekening</p>
                            }
                        </div>
                    }
                    else if (Model.CurrentOption == "Betalen")
                    {
                        <div class="w-100 mb-3 text-center">
                            @{
                                var dishService = new StockServe.Logic.DishService();
                                var allDishes = dishService.GetAllDishes();
                                decimal totalAmount = 0;

                                foreach (var orderDish in Model.TableOrderDishes)
                                {
                                    var dish = allDishes.FirstOrDefault(d => d.Id == orderDish.DishId);
                                    if (dish != null)
                                    {
                                        totalAmount += dish.Price * orderDish.Amount;
                                    }
                                }
                            }

                            <h4>Betalen</h4>
                            <p>Huidige Totaal: <strong>€@totalAmount.ToString("0.00")</strong></p>

                            <form method="post" class="d-flex justify-content-center">
                                <button type="submit" asp-page-handler="Pin" class="btn btn-outline-light me-2">Pin</button>
                                <button type="submit" asp-page-handler="Cash" class="btn btn-outline-light">Cash</button>
                            </form>
                        </div>
                    }

                    else if (Model.CurrentOption == "Terug")
                    {
                        <form method="post">
                            <button type="submit" asp-page-handler="NaarTafelDashbord" class="btn btn-outline-light me-2">Naar TafelDashboard</button>
                        </form>
                    }
                </div>

                <!-- Current Order Items -->
                <div class="text-start mt-4">
                    <h4>Huidige Bestelling</h4>
                    @if (Model.SelectedDishes != null && Model.SelectedDishes.Any())
                    {
                        foreach (var dish in Model.SelectedDishes)
                        {
                            @if (Model.CurrentOption == "VerwijderGerecht")
                            {
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>@dish.Name</span>
                                    <form method="post" asp-page-handler="GerechtVerwijderen" class="ms-2">
                                        <input type="hidden" name="dishId" value="@dish.Id" />
                                        <button type="submit" class="btn btn-outline-danger btn-sm">Verwijder</button>
                                    </form>
                                </div>
                            }
                            else
                            {
                                <p>@dish.Name <span class="float-end">€@dish.Price.ToString("0.00")</span></p>
                            }
                        }
                        <hr />
                        <p class="text-end fw-bold">Totaal: €@Model.SelectedDishes.Sum(d => d.Price).ToString("0.00")</p>
                    }
                    else
                    {
                        <p>Geen gerechten toegevoegd aan bestelling</p>
                    }
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 bg-dark rounded p-3">
            <!--Catogorien worden weergegeven-->
            <div class="d-flex justify-content-start gap-3 mb-3">
                @if (Model.Categories.Any())
                {
                    foreach (var category in Model.Categories)
                    {
                        <a href="?tableId=@tableId&category=@category"
                           class="btn @(category == Model.SelectedCategory ? "btn-primary" : "btn-secondary")">
                            @category
                        </a>
                    }
                }
                else
                {
                    <p>Geen categorieën beschikbaar</p>
                }
            </div>
            <!--Gerechten weergeven rooster-->
            <div class="row row-cols-4 g-3">
                @if (Model.Dishes != null && Model.Dishes.Any())
                {
                    foreach (var dish in Model.Dishes)
                    {
                        <div class="col">
                            <div class="card bg-secondary text-light">
                                <div class="card-body">
                                    <h5 class="card-title">@dish.Name</h5>
                                    <p class="card-text">@dish.Description</p>
                                    <p class="card-text">€@dish.Price.ToString("0.00")</p>
                                    <form method="post" asp-page-handler="AddToOrder">
                                        <input type="hidden" name="dishId" value="@dish.Id" />
                                        <button type="submit" class="btn btn-light w-100">Toevoegen</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12">
                        <p class="text-center">Geen gerechten beschikbaar</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>